## 00 A review of how we got here

* Microservices
* Containers
	* Building and exchanging images
	* Inspecting and starting/stopping images
* Orchestration: [Service Managment, Scheduling, Resource Management]
* Working with real applications
* `Vagrant up` machines into a cluster
* DC/OS GUI and CLI
* Installing a service on DC/OS

## 01 DC/OS - Theory 01 - Basic Concepts

### Key terms to keep in mind:

DC/OS is a distributed OS for the data center built on top of Apache Mesos.

* DC/OS is made up of many components, most notably a distributed systems kernel (Mesos) and a container orchestration engine (Marathon).
* What's not covered in the FOSS version: Enterprise versions include closed-source components and features like multitenancy, fine-grained permissions, secrets management, and end-to-end encryption.

Apache Mesos is a distributed systems kernel that manages cluster resources and tasks.

* Mesos is one of the core components of DC/OS that predates DC/OS itself, bringing maturity and stability to the platform.

**DC/OS builds up on Mesos and uses a lot of similar terminology. It helps to consider the terms in the context of DC/OS as well as Mesos**

#### Nodes

A DC/OS node is a virtual or physical machine on which a Mesos agent and/or Mesos master process runs. DC/OS nodes are networked together to form a DC/OS cluster.

##### Master Node

A DC/OS master node is a virtual or physical machine that runs a collection of DC/OS components that work together to manage the rest of the cluster.

* Each master node contains multiple DC/OS components, including most notably a Mesos master process.
	* A Mesos master is a process that runs on master nodes to coordinate cluster resource management and facilitate orchestration of tasks.
* Master nodes work in a [quorum](https://en.wikipedia.org/wiki/Quorum_%28distributed_computing%29) to provide consistency of cluster coordination. To avoid [split brain](https://en.wikipedia.org/wiki/Split-brain_%28computing%29) cluster partitioning, clusters must have an odd number of master nodes. For example, having three master nodes allows one to be down; having five master nodes allows two to be down, allowing for failure during a rolling update. Additional master nodes can be added for additional risk tolerance.
	* The Mesos masters form a quorum and elect a leader.
	* The lead Mesos master collects resources reported by Mesos agents and makes resource offers to Mesos schedulers. Schedulers then may accept resource offers and place tasks on their corresponding nodes.
* A cluster with only one master node is usable for development, but is not highly available and may not be able to recover from failure.

##### Agent Node

A DC/OS agent node is a virtual or physical machine on which Mesos tasks are run.

* Each agent node contains multiple DC/OS components, including most notably a *Mesos agent* process.
* Agent nodes can be *private* or *public*, depending on agent and network configuration.

* A Mesos agent is a process that runs on agent nodes to manage the executors, tasks, and resources of that node.
* The Mesos agent registers some or all of the node’s resources, which allows the lead Mesos master to **offer those resources** to **schedulers**, which decide on which node to run tasks.
* The Mesos agent reports task status updates to the lead Mesos master, which in turn reports them to the appropriate scheduler.

###### Private Agent Node

A private agent node is an agent node that is on a network that *does not* allow entry or 'ingress' from outside of the cluster via the cluster’s infrastructure networking.

*  The Mesos agent on each private agent node is, by default, configured with none of its resources allocated to any specific Mesos roles.
*  Most service packages install by default on private agent nodes.
*  Clusters are generally comprised of mostly private agent nodes.

###### Public Agent Node

A public agent node is an agent node that is on a network that *does* allow entry or 'ingress' from outside of the cluster via the cluster’s infrastructure networking.

* Public agent nodes are used primarily for externally facing reverse proxy load balancers, like Marathon-LB.
* Clusters generally have only a few public agent nodes, because a single load balancer can handle proxying multiple services.


#### Host Operating System

A host operating system is the operating system that runs on each DC/OS node underneath the DC/OS components, manages the local hardware and software resources, and provides common services for running other programs and services.

* DC/OS currently supports: 
	* [CentOS](https://www.centos.org/), 
	* [RHEL](https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux)
	* [CoreOS](https://coreos.com/).

* While the host OS manges local tasks and machine resources, DC/OS manages cluster tasks and resources so that the user does not generally need to interact with the host operating systems on the nodes.

#### Bootstrap Machine

A bootstrap machine is the machine on which the DC/OS installer artifacts are configured, built, and distributed.

* The bootstrap machine is not technically considered part of the cluster since it does not have DC/OS installed on it (this may change in the future). For most installation methods, the bootstrap node must be accessible to and from the machines in the cluster via infrastructure networking.
* The bootstrap machine is sometimes used as a jumpbox to control SSH access into other nodes in the cluster for added security and logging. *We'll look at the alternative install later today*
* If a bootstrap machine is not required for managing master node IP changes or as an SSH jumpbox, it can be shut down after bootstrapping and spun up on demand to add new nodes to the cluster.

#### Task

A Mesos task is an abstract unit of work, lifecycle managed by a Mesos executor, that runs on a DC/OS agent node.

* Tasks are often processes or threads, but could even just be inline code or items in a single-threaded queue, depending on how their executor is designed.

#### Executor

A Mesos executor is a method by which Mesos agents launch tasks.

* Executor processes are launched and managed by Mesos agents on the agent nodes.
* Mesos **tasks** are defined by their **scheduler** to be run by a specific **executor** (or the default executor).
* Each **executor** runs in its own **container**.

#### Scheduler

A Mesos scheduler is a program that defines new Mesos tasks and assigns resources to them (placing them on specific nodes).

* A scheduler receives resource offers describing CPU, RAM, etc., and allocates them for discrete tasks that can be launched by Mesos agents.
* A **scheduler** must register with Mesos as a **framework**.

#### Framework

A Mesos framework consists of a **scheduler**, **tasks**, and *optionally* **custom executors**.

* *The term framework and scheduler are sometimes used interchangeably. Prefer the term **scheduler**.*

#### Resource Offer

A Mesos resource offer provides a set of unallocated resources (e.g. cpu, disk, memory) from an agent to a scheduler so that the scheduler may allocate those resources to one or more tasks. Resource offers are constructed by the leading Mesos master, but the resources themselves are reported by the individual agents.

Ref: [Application Framework development guide](http://mesos.apache.org/documentation/latest/app-framework-development-guide/).

## 02 DC/OS - Theory 02 - Architecture and Components

### A quick look at architecture

The DCOS Architecture can be divided into three layers:

![ArchLayers](images/arch_layers.png)

#### Software Layer

Package management and repository for multiple types of services: databases, message queues, stream processors, artifact repositories, monitoring solutions, continuous integration tools, source control management, log aggregators, etc. 

#### Platform Layer

Takes care of the following using components (which we'll talk about in a bit):
* Cluster Management
* Container Orchestration
* Container Runtimes
* Logging and Metrics
* Networking
* Package Management
* IAM and Security
* Storage

These components are divided across multiple node types:

* Master Nodes
* Private Agent Nodes
* Public Agent Nodes

#### Infrastructure Layer

At the infrastructure layer, DC/OS can be installed on public clouds, private clouds, or on-premises hardware. Some of these install targets have automated provisioning tools, but almost any infrastructure can be used, as long as it includes multiple x86 machines on a shared IPv4 network.

#### Additional Components 
Also called external components, these include the CLI and GUI that let you interact with the cluster.

### Components:

Most DC/OS components run as systemd services on the DC/OS nodes.

To see a list of the systemd components running on any node, list the contents of the `/etc/systemd/system/dcos.target.wants/` directory or execute `systemctl | grep dcos-` to see their current status.

* SSH into a node, then:
```
systemctl | grep dcos-
```

This should list all the components on the particular node in your DCOS installation.

Here's a bird's eye view of the key components:

![Components](images/components.png)

DC/OS components are installed, upgraded, and managed by DC/OS Component Package Manager (`Pkgpanda` - Package Panda - a package manager for `systemd` units).

Check out the packages directory of the DC/OS source repository, to see what gets installed when we `vagrant up` our cluster.

Let's take a closer look at some of the components, we'll be running a few in detail in the labs that follow:

#### Cluster Management vis Mesos Master, Exhibitor and Zookeeper

##### Mesos 

manages resources and tasks as a distributed systems kernel. Mesos Master exposes scheduler, executor, and operator interfaces to facilitate cluster management. Mesos Agent manages individual executors, tasks, and resources on each DC/OS agent node. Mesos Agent Public is a Mesos Agent configured to run on DC/OS public agent nodes.

###### System Services:

* `dcos-mesos-master.service`
* `dcos-mesos-slave.service`
* `dcos-mesos-slave-public.service`

##### Zookeeper 

provides consistent, highly available, distributed key-value storage for configuration, synchronization, name registration, and cluster state storage.

##### Exhibitor 

*supervises* Zookeeper and provides a management web interface.

###### System Service:

* `dcos-exhibitor.service`

#### Container orchestration 

The continuous, automated scheduling, coordination, and management of containerized processes and the resources they consume.

##### Marathon 

orchestrates long-running containerized services (apps and pods).

###### System Service:

`dcos-marathon.service`

##### DC/OS Jobs or Metronome

orchestrates short-lived, scheduled or immediate, containerized jobs.

###### System Service:

`dcos-metronome.service`

#### Logging and Metrics

##### DC/OS Diagnostics (3DT) 

aggregates and exposes component health. DC/OS Diagnostics is also known as DC/OS Distributed Diagnostics Tool (3DT).

###### Services:

* `dcos-3dt.socket`
* `dcos-3dt.service`

#####  DC/OS Log service exposes node, component, and container (task) logs.

###### Services:

`dcos-log-master.service`
`dcos-log-master.socket`
`dcos-log-agent.service`
`dcos-log-agent.socket`

##### Logrotate 

manages rotation, compression, and deletion of historical log files.

###### Services:

`dcos-logrotate-master.service`
`dcos-logrotate-master.timer`
`dcos-logrotate-agent.service`
`dcos-logrotate-agent.timer`

##### DC/OS Metrics service 

exposes node, container, and application metrics.

###### Services:

`dcos-metrics-master.service`
`dcos-metrics-master.socket`
`dcos-metrics-agent.service`
`dcos-metrics-agent.socket`

##### DC/OS Signal service 

reports cluster telemetry and analytics to help improve DC/OS. Administrators can opt-out of telemetry at install time.

###### Services:

`dcos-signal.service`
`dcos-signal.timer`

##### DC/OS History service 

caches and exposes historical system state to facilitate cluster usage statistics in the GUI.

###### Service:

`dcos-history.service`

#### Networking

##### Admin Router 

exposes a unified control plane proxy for components and services using NGINX. Admin Router Agent proxies node-specific health, logs, metrics, and package management internal endpoints.

###### Services:

* `dcos-adminrouter.service`
* `dcos-adminrouter-reload.service`
* `dcos-adminrouter-reload.timer`
* `dcos-adminrouter-agent.service`
* `dcos-adminrouter-agent-reload.service`
* `dcos-adminrouter-agent-reload.timer`

##### Mesos DNS 

provides domain name based service discovery within the cluster.

###### Services:

* `dcos-mesos-dns.service`

##### DNS Forwarder (Spartan) 

forwards DNS requests to multiple DNS servers. Spartan Watchdog restarts Spartan when it is unhealthy.

###### Services:

* `dcos-spartan.service`
* `dcos-spartan-watchdog.service`
* `dcos-spartan-watchdog.timer`

##### Generate resolv.conf 

configures network name resolution by updating /etc/resolv.conf to facilitate DC/OS's software defined networking.

###### Services:

* `dcos-gen-resolvconf.service`
* `dcos-gen-resolvconf.timer`

##### Minuteman 

provides distributed Layer 4 virtual IP load balancing.

###### Services:

* Included in Navstar

##### Navstar 

orchestrates virtual overlay networks using VXLAN.

###### Services:

* `dcos-navstar.service`

##### Erlang Port Mapping Daemon (EPMD) 

facilitates communication between distributed Erlang programs.

###### Services:

* `dcos-epmd.service`

#### Package Management
##### DC/OS Package Manager (Cosmos)

installs and manages DC/OS packages from DC/OS package repositories, such as the Mesosphere Universe.

###### Services:

* `dcos-cosmos.service`

##### DC/OS Component Package Manager (Pkgpanda) installs and manages DC/OS components.

###### Services:

* `dcos-pkgpanda-api.service`
* `dcos-pkgpanda-api.socket`

